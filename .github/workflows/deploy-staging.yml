# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ğŸ§ª GitHub Actions: Test & Deploy to EC2 (Staging/UAT)                      â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ ğŸ“Œ Trigger: Push to `uat` branch                                           â”‚
# â”‚ ğŸ“¦ Jobs:                                                                   â”‚
# â”‚   â€¢ Run Go unit/integration tests                                          â”‚
# â”‚   â€¢ Only if tests pass â†’ SSH into EC2 instance                             â”‚
# â”‚   â€¢ Pull latest code from `uat` branch                                     â”‚
# â”‚   â€¢ Rebuild and restart Docker containers using Docker Compose             â”‚
# â”‚ ğŸ“ Environment: uat                                                        â”‚
# â”‚ ğŸ” Uses GitHub Secrets for EC2 host, user key, etc.                        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Test & Deploy to Staging (UAT)

on:
  push:
    branches:
      - uat

jobs:
  test:
    name: ğŸ§ª Run Go Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Use your actual Go version

      - name: ğŸ§ª Run Unit & Integration Tests
        run: |
          go test ./... -v

  deploy:
    name: ğŸš€ Deploy to EC2 (Staging)
    needs: test # âœ… Run this only if the 'test' job succeeds
    runs-on: ubuntu-latest
    environment: uat

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.STAGING_HOST }}          # ğŸ–¥ï¸ EC2 public IP or hostname
          username: ubuntu                            # ğŸ‘¤ Default user for Ubuntu AMIs
          key: ${{ secrets.STAGING_KEY }}             # ğŸ”‘ SSH private key
          script: |
            cd /home/ubuntu/test-server/visitorServer
            echo "ğŸ“¦ Pulling latest changes from uat branch..."
            git pull origin uat
            echo "ğŸ›‘ Stopping current containers..."
            sudo docker-compose down
            echo "ğŸ”„ Rebuilding and starting containers..."
            sudo docker-compose up -d --build
            echo "âœ… Deployment to Staging (UAT) completed."

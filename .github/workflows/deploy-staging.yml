# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ ğŸš€ GitHub Actions: Deploy to EC2 (Staging/UAT)              â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ ğŸ“Œ Trigger: Push to `uat` branch                             â”‚
# â”‚ ğŸ§± Jobs:                                                     â”‚
# â”‚   â€¢ Checkout code                                            â”‚
# â”‚   â€¢ SSH into EC2 instance                                    â”‚
# â”‚   â€¢ Pull latest from `uat` branch                            â”‚
# â”‚   â€¢ Rebuild and restart Docker containers using Compose      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

name: Deploy to Staging (UAT)

on:
  push:
    branches:
      - uat  # âœ… Trigger this workflow when code is pushed to 'uat' branch

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest  # ğŸƒ GitHub-hosted runner with Ubuntu

    environment: uat  # ğŸŒ Optional GitHub environment (for tracking/staging secrets)

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4  # ğŸ“¥ Check out the repository code

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.10  # ğŸ” SSH into the EC2 instance
        with:
          host: ${{ secrets.STAGING_HOST }}  # ğŸ–¥ï¸ EC2 public IP or DNS
          username: ubuntu                   # ğŸ‘¤ EC2 user (default for Ubuntu AMIs)
          key: ${{ secrets.STAGING_KEY }}    # ğŸ”‘ SSH private key (stored in GitHub Secrets)
          script: |
            cd /home/ubuntu/test-server/visitorServer
            echo "ğŸ“¦ Pulling latest changes from uat branch..."
            git pull origin uat
            echo "ğŸ›‘ Stopping current containers..."
            sudo docker-compose down
            echo "ğŸ”„ Rebuilding and starting containers..."
            sudo docker-compose up -d --build
            echo "âœ… Deployment to Staging (UAT) completed."
